---
title: "Coverage of Final Data"
output: 
  html_document:
    number_sections: true
editor_options: 
  chunk_output_type: console
---


> In this script all coverages are calculated, based on the final data files

Structure: 

1. Read in data
2. Prepare data for all coverage calculations
3. Produce coverage data tables
4. Produce coverage figures

```{r setup, include=FALSE, error=TRUE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE)


# install.packages(c("rgeos","rgdal"))
# install.packages(c("rnaturalearth", "rnaturalearthdata"))
#install.packages("ggpubr")
library(tidyverse)
library(sf)
library(ggplot2)
library(ggpubr)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(patchwork)
library(knitr)
library(kableExtra)
library(gridExtra)
library(rlang)
library(scales)
library(DT)


# clear R environment
rm(list = ls())

```

# Read in data
```{r , echo = FALSE, message = FALSE, results = "hide"} 
# read final mine-level data
general <- st_read("./04_output/01_detailed_data/08_final_data/final_format_csv/general.gpkg") %>% tibble()
general_sf <- st_read("./04_output/01_detailed_data/08_final_data/final_format_csv/general.gpkg")

detailed <- read_rds("./04_output/01_detailed_data/08_final_data/other_formats/detailed_final.rds")
sheet_min <- detailed$minerals_ores_conce
sheet_com <- detailed$commodities
sheet_coal <- detailed$coal


#read in converted data, as it is needed to get number of sources really used
detailed_converted <- read_rds("./03_intermediate/01_detailed_data/all_tables_converted.rds") 


# read functions needed
source("./02_scripts/00_functions/lastfile.R")
source("./02_scripts/00_functions/get_other_material_ids.R")


# read in national accounts based on UNEP IRP (2022)
lastfile <- my_lastfile("./01_input/05_other_data/", "data_for_comparison")

nat_acc <- read_delim(
  lastfile,
  col_types = (cols(unit_id = "c")),
  delim = ";"
  ) %>%
  select(-source)


# get polygon data of the world's countries from naturalearth package
world <- ne_countries(scale = "medium", returnclass = "sf")


#read table material_ids and source_ids
mat_ids <- read_csv("./04_output/01_detailed_data/08_final_data/final_format_csv/material_ids.csv")
source_ids <- read_csv("./04_output/01_detailed_data/08_final_data/final_format_csv/source_ids.csv")

```

# Prepare data

## data for coverage shares per material

### Adjustments in nat_acc
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

# convert all coal-related material ids in nat_acc to F.coal 
coal_ids <- mat_ids %>% filter(material_category_2 == "coal & peat" & material_id != "F.pea") %>%
  select(material_id) %>% 
  pull()

nat_acc <- nat_acc %>% 
  mutate(material_id = ifelse(material_id %in% coal_ids, "F.coal", material_id)) %>% 
  group_by(alphanumiso, material_id, year) %>% 
  summarize(value = sum(value)) %>%
  ungroup()

# include GID column in nat_acc with the three-letter country code and rename
nat_acc <- nat_acc %>% 
  mutate(GID_0 = substr(alphanumiso, 1, 3)) %>% 
  rename(material = material_id)
  
```

### Preparation of sheet Minerals (country)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

# select relevant data only
sheet_min <- sheet_min %>%
  filter(!(value_tonnes %>% is.na())) %>%
  filter(!(type %in% c("Ore processed"))) %>%
  select(facility_id, year, material, value_tonnes)


# get concentrate production of mines and years where only iron concentrate was produced
con.fe_prod_only <- sheet_min %>% 
  filter(material %in% c("O.Fe", "Con.Fe")) %>% 
  group_by(facility_id, year) %>% 
  summarize(material = paste0(unique(material), collapse = ";"),
            value_tonnes = sum(value_tonnes)) %>% 
  ungroup() %>% 
  filter(material == "Con.Fe") %>% 
  mutate(material = "O.Fe")

# insert iron concentrate as iron ore, ONLY for mines and years where no iron ore production is reported
sheet_min <- sheet_min %>% 
  filter(material != "Con.Fe") %>% 
  bind_rows(con.fe_prod_only)
  

# group by material, to aggregate production by materials that were renamed above
sheet_min <- sheet_min %>% 
  group_by(facility_id, year, material) %>% 
  summarize(value_tonnes = sum(value_tonnes)) %>% 
  ungroup()

```

### Preparation of sheet Commodities (country)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
# select relevant data only
sheet_com <- sheet_com %>%
  filter(!(value_tonnes %>% is.na())) %>%
  select(facility_id, year, commodity, value_tonnes) %>% 
  rename(material = commodity)


# adjust materials which represent a specific metal, but have other material_id
# in order to have proper coverage for these metals

# copper cathode to copper (i.e. Oth.cuca to Me.Cu)
sheet_com <- sheet_com %>%
  mutate(material = ifelse(
    material == "Oth.cuca",
    "Me.Cu",
    material
  ))


# group by material, to aggregate production by materials that were renamed above
sheet_com <- sheet_com %>% 
  group_by(facility_id, year, material) %>% 
  summarize(value_tonnes = sum(value_tonnes)) %>% 
  ungroup()

```

### Preparation of sheet Coal (country)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

# change all types of coal to F.coal
sheet_coal <- sheet_coal %>% 
  filter(type == "Coal mined") %>% 
  mutate(material = "F.coal") %>% 
  group_by(facility_id, year, type, material) %>% 
  summarize(value_tonnes = sum(value_tonnes)) %>% 
  ungroup() %>% 
  select(-type)

# aggregate production of sub-sites and allocate to parent facilities, as only those are linked to countries
sheet_coal <- sheet_coal %>% 
  mutate(facility_id = paste0(substr(facility_id, 1, 9), "00")) %>% 
  group_by(facility_id, year, material) %>% 
  summarize(value_tonnes = sum(value_tonnes))

```

### Preparation of comprehensive Coverage data file (country)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

# join all production sheets together
production <- bind_rows(sheet_min, sheet_com, sheet_coal)

# include country ids
production <- production %>%
  left_join(general %>%
              select(facility_id, country, GID_0, country),
            by = "facility_id")

# check if all mines are linked to countries
# production %>% 
#   filter(GID_0 %>% is.na()) %>%
#   nrow() == 0

# group by country
prod_by_country <- production %>% 
  group_by(GID_0, country, year, material) %>% 
  summarize(value = sum(value_tonnes)) %>% 
  ungroup()


cov_by_country <- prod_by_country %>% 
  left_join(nat_acc %>% 
              select(GID_0, material, year, value),
            by = c("GID_0", "material", "year"),
            suffix = c("_det", "_nat")) 


# data rows without allocation
not_incl_country <- cov_by_country %>%
  filter(
    is.na(GID_0) |
    is.na(material) |
    is.na(value_nat)
    ) %>%
  mutate(cause = case_when(is.na(GID_0) ~ "Country not matched",
                           is.na(material) ~ "Material not matched",
                           is.na(value_nat) ~ "national data missing",
                           TRUE ~ "Other")) %>% 
  group_by(material, cause) %>%
  summarise(n = n(), 
            cause = unique(cause))

# define sheet before cleaning rows without national data
# this sheet will then be used to calculate global coverage
cov_by_country_before_cleaning <- cov_by_country

# calculate share and clean 
cov_by_country <- cov_by_country %>% 
  mutate(share = value_det / value_nat) %>%  #calculate share
  filter(!( #clean
    is.na(GID_0) |
    is.na(material) |
    is.na(value_nat) |
    is.na(share)
    )) %>% 
  left_join(., mat_ids %>% select(material_id, material_name), #join material names
            by = c("material" ="material_id")) %>% 
  mutate(material_name = ifelse(material_name == "Coal (unspecified)", "Coal", material_name)) #rename coal entries


```

### Preparation of comprehensive Coverage data file (global)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

# prepare global production of materials from national accounts
nat_acc_global <- nat_acc %>% 
  group_by(material, year) %>% 
  summarize(value = sum(value)) %>% 
  ungroup() 

cov_global <- cov_by_country_before_cleaning %>% 
  group_by(year, material) %>% 
  summarize(value = sum(value_det)) %>%
  ungroup() %>% 
  left_join(nat_acc_global,
            by = c("material", "year"),
            suffix = c("_det", "_nat"))


# data rows without allocation for global coverage
not_incl_global <- cov_global %>%
  filter(
    is.na(material) |
    is.na(value_nat)
    ) %>%
  mutate(cause = case_when(is.na(material) ~ "Material not matched",
                           is.na(value_nat) ~ "national data missing",
                           TRUE ~ "Other")) %>% 
  group_by(material, cause) %>%
  summarise(n = n(), 
            cause = unique(cause))


# calculate share and clean
cov_global <- cov_global %>% 
  mutate(share = value_det / value_nat) %>%  #calculate share
  filter(!( #clean
    is.na(material) |
    is.na(value_nat) |
    is.na(share)
    )) %>% 
  left_join(., mat_ids %>% select(material_id, material_name), #join material names
            by = c("material" ="material_id")) %>% 
  mutate(material_name = ifelse(material_name == "Coal (unspecified)", "Coal", material_name)) #rename coal entries


```

### Filter relevant timeframe only of coverage data
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
cov_by_country <- cov_by_country %>% 
  filter(1999 < year & year < 2019)

cov_global <- cov_global %>% 
  filter(1999 < year & year < 2019)

```

## data for spatial coverage

### clean spatial data
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

# get only facilities, and only those that are georeferenced
general_sf <- general_sf %>% 
  filter(is.na(sub_site_name),
         !(geom %>% st_is_empty()))

# preparing the world map
world <- world %>% 
  filter(continent != "Antarctica")


```

### Determine primary commodity and facility type for every facility
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

# get all commodities that are produced for every mine
unique_min <- detailed$minerals_ores_conce %>%
  group_by(facility_id) %>%
  summarize(material_ids = material %>% unique()) %>%
  ungroup() %>% 
  filter(!(material_ids %in% "O.bulk")) # filter out entries with bulk ore and concentrate, as it does not help in specifing the primary material

unique_com <- detailed$commodities %>% 
  group_by(facility_id) %>%
  summarize(material_ids = commodity %>% unique()) %>%
  ungroup()

unique_coal <- detailed$coal %>% 
  group_by(facility_id) %>%
  summarize(material_ids = material %>% unique()) %>%
  ungroup() 

unique_all <- bind_rows(unique_min, unique_com, unique_coal) %>% 
  group_by(facility_id) %>%
  summarize(materials_produced = paste(unique(material_ids), collapse = "; ")) %>%
  ungroup() %>% 
  arrange(facility_id)


# add column materials_produced to table general
general_sf <- general_sf %>% 
  left_join(unique_all, by = "facility_id")


# define materials which can be included and CAN NOT be included in materials_produced to belong to a category primary_material
coal_ids <- c(aggregate_mat_ids("material_category_2", "coal & peat", mat_ids), "F.stc")

iron_ids <- c("O.Fe", "Me.Fe", "Con.Fe", "Con.FeN", "Oth.sif")
not_iron_ids <- c("O.FeS", "O.FeTiO3", "O.TiO2", "Me.Cu", "Me.Au", "O.Zr", "O.leu") %>% paste(., collapse = "|")

aluminium_ids <- c("O.Al", "Me.Al2O3")

gold_ids <- c("O.Au", "Me.Au", "Con.Au")
not_gold_ids <- other_mat_ids(gold_ids, mat_ids)

copper_ids <- c("O.Cu", "Me.Cu", "Con.Cu", "Oth.Cuca", "Oth.Cuce")

pgm_ids <- c(aggregate_mat_ids("material_id_agg", "Me.pgm", mat_ids), 
             "O.pgm", "Me.pgm", "Con.pgm")
not_pgm_ids <- other_mat_ids(pgm_ids, mat_ids)

polymetallic_ids <- c(aggregate_mat_ids("material_category_2", "metal ore", mat_ids), 
                      aggregate_mat_ids("material_category_2", "metal", mat_ids),
                      aggregate_mat_ids("material_category_2", "metal compound", mat_ids))



general_sf <- general_sf %>% 
  mutate(primary_commodity = case_when(grepl("Refinery|Smelter", facility_type) & 
                                         !(grepl("Mine", facility_type)) ~ "Processing",
                                       grepl(paste(coal_ids, collapse = "|"), materials_produced) ~ "Coal",
                                       grepl(paste(iron_ids, collapse = "|"), materials_produced) &
                                         !(grepl(not_iron_ids, materials_produced)) ~ "Iron",
                                       grepl(paste(aluminium_ids, collapse = "|"), materials_produced) ~ "Aluminium",
                                       grepl(paste(gold_ids, collapse = "|"), materials_produced) &
                                         !(grepl(not_gold_ids, materials_produced)) ~ "Gold",
                                       grepl(paste(pgm_ids, collapse = "|"), materials_produced) &
                                         !(grepl(not_pgm_ids, materials_produced)) ~ "PGM",
                                       grepl(paste(polymetallic_ids, collapse = "|"), materials_produced) ~ "Other (poly)-metallic",
                                       TRUE ~ "Other mine"))

# create a separate dataframe where copper mines are a distinct category
general_sf_copper <- general_sf %>% 
  mutate(primary_commodity = ifelse(grepl(paste(copper_ids, collapse = "|"), materials_produced), "Copper", primary_commodity))
  

# checking

# check how many entries per category
# general_sf %>%
#   st_drop_geometry() %>%
#   group_by(primary_commodity) %>%
#   summarize(n())

# check what unique combinations of commodities correspond to one category primary commodity
# general_sf %>% 
#   st_drop_geometry() %>% 
#   filter(primary_commodity == "Other (poly)-metallic") %>% 
#   select(materials_produced) %>% 
#   pull() %>%
#   unique()

```

# Produce coverage data tables

## Coverage of table general (data tables)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
# load in the original sheets again
sheet_min <- detailed$minerals_ores_conce
sheet_com <- detailed$commodities
sheet_coal <- detailed$coal


# calculate nr of sources really used (as nrow of source_ids is inaccurate, some might not be used any more)
unique_sources <- c()
for(sheet_number in c(1:length(detailed_converted))){
  temp_sources <- detailed_converted[[sheet_number]]$source_id %>%
    unique()
  not_incl <- setdiff(temp_sources, unique_sources)
  unique_sources <- c(unique_sources, not_incl)
}

# set up tibble for data table output
gen_cov <- tibble(Indicator = NA, Amount = NA) %>% 
  filter(!is.na(Amount)) %>%
  mutate(Indicator = as.character(Indicator), Amount = as.numeric(Amount))

gen_cov <- gen_cov %>%
  union(., tibble(
    Indicator = "Number of countries",
    Amount = general %>% distinct(country) %>% nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of mines / processing facilities",
    Amount = general %>% distinct(facility_name) %>% nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of materials (w/o processing)",
    Amount = (sheet_min %>% distinct(material) %>% nrow()) +
      (sheet_com %>% distinct(commodity) %>% nrow())
  )) %>%
  union(., tibble(
    Indicator = "Number of years",
    Amount = length(union(sheet_min$year, sheet_com$year))
  )) %>%
  union(., tibble(
    Indicator = "Number of grades",
    Amount = sheet_com %>% filter(!is.na(grade_ppm)) %>% nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of yields",
    Amount = sheet_com %>% filter(!is.na(yield_ppm)) %>% nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of recovery rates",
    Amount = sheet_com %>% filter(!is.na(recovery_rate)) %>% nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of sources",
    Amount = source_ids %>% nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of sources really used",
    Amount = unique_sources %>% length()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities + sub-sites",
    Amount = general %>% nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities",
    Amount = general %>% distinct(facility_name) %>% na.omit() %>% nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of sub-sites",
    Amount = general  %>% 
      filter(!is.na(sub_site_name)) %>% 
      distinct(facility_name, sub_site_name) %>% 
      nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities with at least one coordinate",
    Amount = sum(!(general %>% 
      filter(is.na(sub_site_name)) %>%
      st_as_sf() %>%
      st_is_empty()))
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities with no coordinates",
    Amount = general %>% 
      filter(is.na(sub_site_name)) %>%
      st_as_sf() %>%
      st_is_empty() %>% 
      sum()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities with POINT geometry",
    Amount = general %>% 
      filter(is.na(sub_site_name),
             !(geom %>% st_is_empty()), 
             geom %>% lengths() == 2) %>%
      nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities with MULTIPOINT geometry",
    Amount = general %>% 
      filter(is.na(sub_site_name),
             !(geom %>% st_is_empty()), 
             geom %>% lengths() > 2) %>%
      nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities of type Mine",
    Amount = general %>%
      filter(facility_type == "Mine") %>% 
      nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities of type Smelter",
    Amount = general %>%
      filter(facility_type == "Smelter") %>% 
      nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities of type Refinery",
    Amount = general %>%
      filter(facility_type == "Refinery") %>% 
      nrow()
  )) %>%
  union(., tibble(
    Indicator = "Number of facilities of type Other (mixed forms + company + region)",
    Amount = general %>%
      filter(!(facility_type %in% c("Mine", "Smelter", "Refinery"))) %>% 
      nrow()
  ))

# table for Rmd output
datatable(gen_cov, rownames = FALSE, caption = "General coverage final data")



# number of mines/facilities by type
nr_min_fac <- general %>%
  group_by(facility_type) %>%
  summarise(n = n())

# table for Rmd output
datatable(nr_min_fac, rownames = FALSE, caption = "Number of mines/facilities by type")



# nr of materials per category
nr_mat_by_cat <- sheet_min %>%
  distinct(material) %>%
  rename(material_id = material) %>%
  union(.,
        sheet_com %>%
          distinct(commodity) %>%
          rename(material_id = commodity)
  ) %>%
  filter(!is.na(material_id)) %>%
  left_join(.,
    mat_ids %>% select(material_category, material_category_2, material_id)
  ) %>%
  group_by(material_category, material_category_2) %>%
  summarise(n = n())

# table for Rmd output
datatable(nr_mat_by_cat, rownames = FALSE, caption = "Number of materials per category")



# nr of mines/facilities per country
nr_min_fac_by_cou <- general %>%
  filter(sub_site_name %>% is.na()) %>% 
  group_by(country) %>%
  summarise(n = n()) %>%
  arrange(desc(n))
  
# table for Rmd output
datatable(nr_min_fac_by_cou, rownames = FALSE, caption = "Number of mines per country")



# nr of materials per country
nr_mat_by_cou <- sheet_min %>%
  distinct(facility_id, material) %>%
  rename(material_id = material) %>%
  union(.,
        sheet_com %>%
          distinct(facility_id, commodity) %>%
          rename(material_id = commodity)
        ) %>%
  left_join(.,
            general %>%
              select(facility_id, country)
            ) %>%
  distinct(material_id, country) %>%
  group_by(country) %>%
  summarise(n = n()) %>%
  arrange(desc(n))

# table for Rmd output
datatable(nr_mat_by_cou, rownames = FALSE, caption = "Number of materials per country")



# nr of mines per material (processing not included)
nr_mine_by_mat <- sheet_min %>%
  distinct(facility_id, material) %>%
  rename(material_id = material) %>%
  union(.,
        sheet_com %>%
          distinct(facility_id, commodity) %>%
          rename(material_id = commodity)
        ) %>%
  distinct(material_id, facility_id) %>%
  group_by(material_id) %>%
  summarise(n = n()) %>%
  arrange(desc(n))

# table for Rmd output
datatable(nr_mine_by_mat, rownames = FALSE, caption = "Number of mines per material")



```

## Coverage of Materials by country (data tables)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

cov_by_country_table <- cov_by_country %>% 
  mutate(share = percent(share, accuracy = 1)) %>%
  select(-value_det, -value_nat) %>%
  arrange(desc(year)) %>%
  pivot_wider(., names_from = year, values_from = share) %>%
  arrange(material) %>%
  # insert national totals again in order to rank properly (couldn't be kept, because of pivot function)
  left_join(., cov_by_country %>% filter(year == 2015) %>% select(country, value_nat)) %>%
  arrange(material, desc(value_nat))


# table for Rmd output
datatable(cov_by_country_table, rownames = FALSE, caption = "Relative coverage by material and country")


## get coverages above 100%

# filter for shares >100%
exc_cov <- cov_by_country %>%
  filter(share > 1) %>%
  mutate(share = percent(share, accuracy = 1)) %>%
  mutate(
    `Abs. diff larger than nat. value` = value_det - value_nat,
    unit = "t") %>%
  arrange(GID_0, material, year)

# select "responsible" mines
exc_cov_mines <- exc_cov %>%
  select(GID_0, material, year) %>%
  left_join(., 
            production %>% select(GID_0, material, year, facility_id, value_tonnes)
            ) %>%
  arrange(GID_0, material, year, desc(value_tonnes))


# use tempory tibble and loop to get respective mines into one string
  # (shorter options didn't work somehow)

temp_t <- tibble(GID_0 = "chr", material = "chr", year = 1, mines = "chr") %>% 
  filter(mines != "chr")

for (i in 1:nrow(exc_cov)) {
  
  a <- exc_cov[i,] %>% select(GID_0, material, year)
  
  mine_str <- a %>%
    left_join(exc_cov_mines) %>%
    distinct(facility_id) %>%
    pull() %>%
    paste0(collapse = ", ")
  
  temp_t <- temp_t %>%
    union(., a %>% mutate(mines = mine_str))
  
}

exc_cov <- exc_cov %>%
  left_join(., temp_t)

# table for Rmd output
datatable(exc_cov, rownames = FALSE, caption = "Coverages which are >100% for sheets coal, minerals, commodities. ")
# possibly join here the mine name to the facility_id
# possibly insert method to split this into sheets coal, minerals, commodities.

```

## Coverage of Materials global (data tables)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

cov_global_table <- cov_global %>% 
  mutate(share = percent(share, accuracy = 1)) %>%
  select(-value_det, -value_nat) %>%
  arrange(desc(year)) %>%
  pivot_wider(., names_from = year, values_from = share) %>%
  arrange(material) %>%
  # insert national totals again in order to rank properly (couldn't be kept, because of pivot function)
  left_join(., cov_global %>% filter(year == 2015) %>% select(material, value_nat)) %>%
  arrange(material, desc(value_nat))

# table for Rmd output
datatable(cov_global_table, rownames = FALSE, caption = "Relative global coverage by material")

```



## Data rows not included in coverage (data tables)
```{r , echo = FALSE, message = FALSE, warning = FALSE}

# table for Rmd output
datatable(not_incl_country, rownames = FALSE, caption = "Number of data rows not included in coverage by country calculation")

# table for Rmd output
datatable(not_incl_global, rownames = FALSE, caption = "Number of data rows not included in global coverage calculation")

```

# Produce coverage figures

## Coverage of table general (export figures)
```{r , echo = FALSE, message = FALSE, warning = FALSE}
pdf(file = "./04_output/01_detailed_data/05_coverage/01_general/mines_per_country.pdf",
    width = 16,
    height = 8)

# export figure for number of mines per country 
ggplot(data = head(nr_min_fac_by_cou), aes(x = reorder(country, -n), y = n)) + 
  geom_bar(stat = "identity", fill = "steelblue") + 
  geom_text(aes(label = n), vjust = 1.6, color = "white", size = 3.5)+
  labs(x = "Country", y = "No. of Mines")


# export figure of number of mines per material
nr_mine_by_mat_plot <- left_join(nr_mine_by_mat, select(mat_ids, material_id, material_name), by = "material_id")
nr_mine_by_mat_plot$material_name <- coalesce(nr_mine_by_mat_plot$material_name, nr_mine_by_mat_plot$material_id)
nr_mine_by_mat_plot <- nr_mine_by_mat_plot %>% mutate(material_name = replace(material_name, material_name == "F.stc", "Steam coal"))

ggplot(data = head(nr_mine_by_mat_plot), aes(x = reorder(material_name, -n), y = n)) + 
  geom_bar(stat = "identity", fill = "steelblue") + 
  geom_text(aes(label = n), vjust = 1.6, color = "white", size = 3.5)+
  labs(x = "Material", y = "No. of Mines") 

dev.off()

```

## Global coverage (line charts)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
# select which materials should be displayed
# cov_global$material_name %>% unique()
# cov_global$material %>% unique()
line_plot_materials <-  c("F.coal", "Me.Ag", "Me.Au","Me.Cu", "Me.Mo", "Me.Ni", "Me.Pb", "Me.Zn", 
                          "Me.Co",  "Me.Sn","Me.Pd", "Me.Pt", "Me.Rh", "O.Al", "O.Fe")
line_plot_materials_important_comms <- c("F.coal", "O.Fe", "O.Al", "Me.Cu", "Me.Au", "Me.Mo", "Me.Ni", "Me.Pb", "Me.Zn")

cov_plot_materials <- filter(cov_global, material %in% line_plot_materials)
cov_plot_materials_important_comms <- filter(cov_global, material %in% line_plot_materials_important_comms)

# produce global plots
# almost all commodities
cov_plot_global <- ggplot(cov_plot_materials, aes(x=year, y=share, group=material_name)) +
  geom_line(aes(color=material_name), size = 1)+
#  geom_point(aes(color=material_name))+
  theme(legend.position="top") + 
  ylim(0, 1)

# most important comms only
cov_plot_global_important_comms <- ggplot(cov_plot_materials_important_comms, aes(x=year, y=share, group=material_name)) +
  geom_line(aes(color = material_name), size = 1)+
#  geom_point(aes(color=material_name))+
  theme(legend.position="top") + 
  ylim(0, 1)

# create a line chart of the coverage of selected commodities and minerals groups only
cov_plot_group1 <- filter(cov_global, material %in% c("Me.Ag", "Me.Au", "Me.Cu", "Me.Mo")) #gold, silver, copper, molybdenum
cov_plot_group2 <- filter(cov_global, material %in% c("Me.Ni", "Me.Pb", "Me.Zn", "Me.Co")) #poly-metallic
cov_plot_group3 <- filter(cov_global, material %in% c("Me.Pd", "Me.Pt", "Me.Rh", "Me.Sn", "Me.Te")) #PGM 
cov_plot_group4 <- filter(cov_global, material %in% c("O.Fe", "O.Al")) #Ores
cov_plot_group5 <- filter(cov_global, material == "F.coal") #Coal
groups <- list(cov_plot_group1, cov_plot_group2, cov_plot_group3, cov_plot_group4, cov_plot_group5)

plot_list <- list()

i = 1
for(group in groups) {
  
  p <- ggplot(group, aes(x=year, y=share, group=material_name)) +
    geom_line(aes(color = material_name), size = 1) +
#    geom_point(aes(color=material_name))+
    theme(legend.position = "top") + 
    ylim(0, 1)

  plot_list[[i]] <- p
  
  i = i + 1
}

# specify path and export figures
pdf(file = "./04_output/01_detailed_data/05_coverage/01_general/coverage_global.pdf",   
    width = 16, 
    height = 8)

cov_plot_global
cov_plot_global_important_comms
plot_list

dev.off()

```

## Global coverage (Heat map)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
## build heatmap of the coverage per country
heatmap_mat_ids <- c("F.coal", "O.Fe", "O.Al", "Me.Cu", "Me.Au", "Me.Mo", "Me.Ni", "Me.Pb", "Me.Zn") %>% 
  rev()

heatmap_mat_names <- tibble(material = heatmap_mat_ids) %>% 
  left_join(cov_global %>% 
              select(material, material_name) %>% 
              distinct()) %>% 
  select(material_name) %>% 
  pull()

# prepare data for heatmap
heatmap_materials <- cov_global %>%
  filter(material %in% heatmap_mat_ids) %>% 
  select(year, share, material, material_name) %>%
  mutate(share = round(share * 100))

heatmap_materials$material_name <- factor(heatmap_materials$material_name, 
                                          ordered = TRUE, 
                                          levels = heatmap_mat_names)



pdf(file = "./04_output/01_detailed_data/05_coverage/01_general/coverage_global_heatmap.pdf",   
    width = 16, 
    height = 8)

ggplot(heatmap_materials) +
  geom_tile(aes(x = year, y = material_name, fill = share)) +
  geom_text(aes(x = year, y = material_name, label = share)) +
  scale_fill_gradient2(mid = "white", high = "steelblue")


dev.off()

```

## Global coverage (line chart tiles)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
## build tile chart with 9 coverage figures
area_plot_ids <- c("F.coal", "O.Fe", "O.Al", "Me.Cu", "Me.Au", "Me.Mo", "Me.Ni", "Me.Pb", "Me.Zn")
area_plot_names <- tibble(material = area_plot_ids) %>% 
  left_join(cov_global %>% 
              select(material, material_name) %>% 
              distinct()) %>% 
  select(material_name) %>% 
  pull()


area_plot_data <- cov_global %>% 
  filter(material %in% area_plot_ids) %>% 
  mutate(across(material_name, factor, levels = area_plot_names))
  

pdf(file = "./04_output/01_detailed_data/05_coverage/01_general/coverage_global_area.pdf",   
    width = 16, 
    height = 8)

ggplot(area_plot_data, 
       aes(x = year, y = share, group = material_name)) + 
  geom_area(color = "steelblue", fill = "steelblue", alpha = 0.6) + 
  scale_x_continuous(limits=c(2000, 2018), breaks = c(seq(2000, 2018, 5), 2018), expand = c(0, 0)) +
  scale_y_continuous(limits=c(0, 1), breaks = seq(0, 1, 0.25), expand = c(0, 0)) +
  ylab("Share of global production covered") + 
  xlab("Year") + 
  theme_minimal() + 
  theme(
    panel.border = element_rect(fill = NA, color = "black"),
    panel.grid.minor.x = element_blank(),
    panel.spacing.x = unit(10, "mm"), 
    plot.margin = margin(t = 3,
                         b = 3,
                         r = 8,
                         l = 3,
                         unit = "mm"),
    strip.text = element_text(size = 15)
      ) + 
  facet_wrap(~ material_name)

dev.off()

```

## National coverage (line charts)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

#clean and filter for only the top commodities
line_plot_materials_nat <-  c("F.coal", "Me.Au","Me.Cu", "Me.Mo", "Me.Ni", "Me.Pb", "Me.Zn", 
                          "Me.Co",  "Me.Pt", "O.Al", "O.Fe")

cov_plot_national <- cov_by_country %>% 
  filter(material %in% line_plot_materials_nat)

countries <- c("USA", "AUS", "CHN", "BRA", "ZAF", "CHL", "PER", "IDN", "IND")
countries_names <- tibble(GID_0 = countries) %>% 
  left_join(cov_by_country %>% 
              select(GID_0, country) %>% 
              distinct()) %>% 
  select(country) %>% 
  pull() %>% 
  as.vector()


plot_list <- list()

for (i in c(1:length(countries))) {
  country <- countries[i]
  country_name <- countries_names[i]

  p <- ggplot(filter(cov_plot_national, GID_0 == !!country), aes(x=year, y=share, group=material_name)) +
    ggtitle(paste0("Coverage ", country_name)) + 
    geom_line(aes(linetype=material_name, color=material_name), size = 1.5)+
    geom_point(aes(color = material_name))+
    theme(legend.position="top") + 
    ylim(0, 1)
  
  plot_list[[i]] <- p
}

pdf(file = "./04_output/01_detailed_data/05_coverage/01_general/coverage_national.pdf",   
    width = 16, 
    height = 8)

plot_list

dev.off()

```

## National coverages (Heat maps)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
## build heatmap of the coverage per country
heatmap_nat_mat_ids <- c("F.coal", "O.Fe", "O.Al", "Me.Cu", "Me.Au", "Me.Mo", "Me.Ni", "Me.Pb", "Me.Zn") %>% 
  rev()

heatmap_nat_mat_names <- tibble(material = heatmap_nat_mat_ids) %>% 
  left_join(cov_global %>% 
              select(material, material_name) %>% 
              distinct()) %>% 
  select(material_name) %>% 
  pull()

# prepare data for heatmap
heatmap_materials_nat <- cov_by_country %>%
  filter(material %in% heatmap_nat_mat_ids) %>% 
  select(year, share, material, material_name, GID_0, country) %>%
  mutate(share = round(share, digits = 2))

heatmap_materials_nat$material_name <- factor(heatmap_materials_nat$material_name, 
                                          ordered = TRUE, 
                                          levels = heatmap_nat_mat_names)

countries_heatmap <- c("USA", "AUS", "CHN", "BRA", "ZAF", "CHL", "PER", "IDN", "IND")
countries_names_heatmap <- tibble(GID_0 = countries) %>% 
  left_join(cov_by_country %>% 
              select(GID_0, country) %>% 
              distinct()) %>% 
  select(country) %>% 
  pull() %>% 
  as.vector()




plot_list <- list()

for (i in c(1:length(countries_heatmap))) {
  country <- countries_heatmap[i]
  country_name <- countries_names_heatmap[i]

  p <- ggplot(heatmap_materials_nat %>% filter(GID_0 == !!country)) +
    ggtitle(paste0("Coverage ", country_name)) + 
    geom_tile(aes(x = year, y = material_name, fill = share)) +
    geom_text(aes(x = year, y = material_name, label = share)) +
    scale_fill_gradient2(low = "red", mid = "white", high = "steelblue")
  
  plot_list[[i]] <- p
}

pdf(file = "./04_output/01_detailed_data/05_coverage/01_general/coverage_national_heatmaps.pdf",   
    width = 16, 
    height = 8)

plot_list

dev.off()

```


## Spatial Coverage WITHOUT copper mines (Map)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 

general_prim_com_levels <- c("Processing", "Coal", "Iron", "Aluminium", "Gold", "PGM", "Other (poly)-metallic", "Other mine")
general_sf$primary_commodity <- factor(general_sf$primary_commodity, levels = general_prim_com_levels)

# define custom colors for mines with specific primary commodities
custom_fill <- c("cornflowerblue", "#374341", "blue", "red3", "gold", "cyan", "grey", "white")
custom_colors <- c(rep("black", 8))
custom_shapes <- c(23, rep(24, 7)) 
custom_sizes <- c(1.2, rep(1.5, 7)) 

ggplot() +
  geom_sf(data = world, color = "grey", fill = "gray96", size = 0.2) +
  geom_sf(
    data = general_sf, 
    aes(shape = primary_commodity,
        fill = primary_commodity,
        color = primary_commodity,
        size = primary_commodity),
    stroke = 0.1) + 
  scale_shape_manual(values = custom_shapes, 
                     name = "Processing facilities and\nmines per primary commodity") +
  scale_fill_manual(values = custom_fill,
                    aesthetics = c("fill"),
                    name = "Processing facilities and\nmines per primary commodity") + 
  scale_color_manual(values = custom_colors,
                    aesthetics = c("color"),
                    name = "Processing facilities and\nmines per primary commodity") + 
  scale_size_manual(values = custom_sizes, 
                    name = "Processing facilities and\nmines per primary commodity") +
  theme_bw() +
  coord_sf(crs = "+proj=latlong", expand = FALSE) + # possibility to change to "robin"
  guides(shape = guide_legend(override.aes = list(size = 3.5))) +
  theme(legend.position = c(0.18,0.25),
        legend.title = element_text(),
        legend.background = element_rect(fill = "gray96", color = "black", size = 0.3),
        legend.key = element_rect(fill = "gray96"),
        legend.key.size = unit(5, "mm"),
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.border = element_blank())


ggsave("./04_output/01_detailed_data/05_coverage/03_spatial/mine-level_data_map_coordinates.pdf", width = 16, height = 8)
ggsave("./04_output/01_detailed_data/05_coverage/03_spatial/mine-level_data_map_coordinates.png", width = 20, height = 9, dpi = 300)

```

## Spatial Coverage WITH copper mines (Map)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
# here copper mines are a category on their own, determined by a mine producing any form of copper
general_prim_com_levels_copper <- c("Processing", "Coal", "Iron", "Aluminium",
                                    "Copper", "Gold", "PGM", "Other (poly)-metallic", "Other mine")
general_sf_copper$primary_commodity <- factor(general_sf_copper$primary_commodity, 
                                              levels = general_prim_com_levels_copper)

# define custom colors for mines with specific primary commodities
custom_fill <- c("cornflowerblue", "#374341", "blue", "red3", "#DC7F64", "gold", "cyan", "grey", "white")
custom_colors <- c(rep("black", 9))
custom_shapes <- c(23, rep(24, 8)) 
custom_sizes <- c(1.2, rep(1.5, 8)) 

ggplot() +
  geom_sf(data = world, color = "grey", fill = "gray96", size = 0.2) +
  geom_sf(
    data = general_sf_copper, 
    aes(shape = primary_commodity,
        fill = primary_commodity,
        color = primary_commodity,
        size = primary_commodity),
    stroke = 0.1) + 
  scale_shape_manual(values = custom_shapes, 
                     name = "Processing facilities and\nmines per primary commodity") +
  scale_fill_manual(values = custom_fill,
                    aesthetics = c("fill"),
                    name = "Processing facilities and\nmines per primary commodity") + 
  scale_color_manual(values = custom_colors,
                    aesthetics = c("color"),
                    name = "Processing facilities and\nmines per primary commodity") + 
  scale_size_manual(values = custom_sizes, 
                    name = "Processing facilities and\nmines per primary commodity") +
  theme_bw() +
  coord_sf(crs = "+proj=latlong", expand = FALSE) + # possibility to change to "robin"
  guides(shape = guide_legend(override.aes = list(size = 3.5))) +
  theme(legend.position = c(0.18,0.25),
        legend.title = element_text(),
        legend.background = element_rect(fill = "gray96", color = "black", size = 0.3),
        legend.key = element_rect(fill = "gray96"),
        legend.key.size = unit(5, "mm"),
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        panel.border = element_blank())


ggsave("./04_output/01_detailed_data/05_coverage/03_spatial/mine-level_data_map_coordinates_copper.pdf", width = 16, height = 8)
ggsave("./04_output/01_detailed_data/05_coverage/03_spatial/mine-level_data_map_coordinates_copper.png", width = 20, height = 9, dpi = 300)

```

## Coverage Coal only (Heat map)
```{r , echo = FALSE, message = FALSE, warning = FALSE} 
## build heatmap of the coverage per country
heatmap_coal_countries <- c("CAN", "COL", "KAZ", "ZAF", "RUS", "IDN", "AUS", "IND", "USA", "CHN")

heatmap_coal_data <- cov_by_country %>%
  filter(material == "F.coal" & GID_0 %in% heatmap_coal_countries) %>% 
  arrange(value_nat) %>%
  select(GID_0, country, share, year) %>% 
  mutate(share = round(share, digits = 2))

heatmap_coal_data$ord_countries <- factor(heatmap_coal_data$GID_0, 
                                          ordered = TRUE, 
                                          levels = c("CAN", "COL", "KAZ", "ZAF", 
                                                     "RUS", "IDN", "AUS", "IND", 
                                                     "USA", "CHN"))

 
pdf(file = "./04_output/01_detailed_data/05_coverage/02_coal/coal_coverage_heatmap.pdf",   
    width = 16, 
    height = 8)

ggplot(heatmap_coal_data) +
  geom_tile(aes(x = year, y = ord_countries, fill = share)) +
  geom_text(aes(x = year, y = ord_countries, label = share)) +
  scale_fill_gradient2(low = "red", mid = "white", high = "steelblue")


dev.off()

```

