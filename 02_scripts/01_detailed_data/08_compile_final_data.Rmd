---
title: "Compile Final Data"
output: html_document
editor_options: 
  chunk_output_type: console
---

###### In this script, the final data output is prepared.
###### 1. sheet_general with general information is compiled and exported
###### 1.1 column mine_id is added to all sheets
###### 2. Four formats for sheet_min and sheet_com are exported
###### 3. Other sheets are exported



### Read In data
```{r , echo = FALSE, message = FALSE} 
library(sf)

# read in sheet_min and sheet_com
detailed <- read_rds("./03_intermediate/01_detailed_data/gaps_filled.rds")

#read in converted data to get sheet_coal including sub_sites
converted <- read_rds("./03_intermediate/01_detailed_data/all_tables_converted.rds")

# read in sheet_general
sheet_general <- st_read("./03_intermediate/01_detailed_data/sheet_general/general.gpkg")
sheet_sub_sites <- st_read("./03_intermediate/01_detailed_data/sheet_general/sub_sites.gpkg")

# read in source IDs
source_ids <- read_delim("./01_input/02_lists_and_concordance_tables/source_ids.csv", delim = ";")

```

<br>

# 1. sheet_general with general information is compiled and exported

### compilation of final data for sheet_general and sheet_sub_sites
```{r , echo = FALSE, message = FALSE} 
# modify data 

# sheet_general
sheet_general <- sheet_general %>% 
  rename(surface_area_sq_km = surface_area,
         concession_area_sq_km = claim_concession_area) %>% 
  select(-unit_surface_area, -unit_concession_area, -certification_scheme) %>% 
  mutate_at(c("concession_area_sq_km", "surface_area_sq_km"), round, digits = 4) %>% 
  arrange(mine_id)


# sheet_sub_sites
sheet_sub_sites <- sheet_sub_sites %>% 
  rename(surface_area_sq_km = surface_area,
         concession_area_sq_km = claim_concession_area) %>% 
  select(-mine_fac, -mine_other_names, -country, -alphanumiso, -state, -region, -province, -district, -sector, -location_municipality, 
         -unit_surface_area, -unit_concession_area, -certification_scheme) %>% 
  mutate_at(c("concession_area_sq_km", "surface_area_sq_km"), round, digits = 4) %>% 
  arrange(mine_id)


# sheet_general_sub_sites
sheet_general_sub_sites <- sheet_general %>% 
  bind_rows(., sheet_sub_sites) %>% 
  relocate(c(sub_site, sub_site_other_name), .after = mine_fac) %>% 
  arrange(mine_id)


# datatable for Rmd output
datatable(head(sheet_general %>% st_drop_geometry()), rownames = FALSE, caption = "sheet_general")
datatable(head(sheet_sub_sites %>% st_drop_geometry()), rownames = FALSE, caption = "sheet_sub_sites")
datatable(head(sheet_general_sub_sites %>% st_drop_geometry()), rownames = FALSE, caption = "sheet_general_sub_sites")


# create the directory for storing sheet_general
dir.create("./04_output/01_detailed_data/08_final_data/general_sub_sites/", showWarnings = FALSE, recursive = TRUE)


# export sheet_general as geopackage
st_write(sheet_general, "./04_output/01_detailed_data/08_final_data/general_sub_sites/sheet_general.gpkg", append = FALSE)

# export sheet_sub_sites as geopackage
st_write(sheet_sub_sites, "./04_output/01_detailed_data/08_final_data/general_sub_sites/sheet_sub_sites.gpkg", append = FALSE)

# export sheet_general_sub_sites as geopackage
st_write(sheet_general_sub_sites, "./04_output/01_detailed_data/08_final_data/general_sub_sites/sheet_general_sub_sites.gpkg", append = FALSE)

# export sheet_general as CSV
write_csv(sheet_general %>% 
            st_drop_geometry() %>% 
            select(-GADM_level, -n_features), 
          "./04_output/01_detailed_data/08_final_data/general_sub_sites/sheet_general.csv", na = "")

# export sheet_sub_sites as CSV
write_csv(sheet_sub_sites %>% 
            st_drop_geometry(),
          "./04_output/01_detailed_data/08_final_data/general_sub_sites/sheet_sub_sites.csv", na = "")

# export sheet_general_sub_sites as CSV
write_csv(sheet_general_sub_sites %>% 
            st_drop_geometry() %>% 
            select(-GADM_level, -n_features), 
          "./04_output/01_detailed_data/08_final_data/general_sub_sites/sheet_general_sub_sites.csv", na = "")

```

<br>

### gap filling for sheet_coal
```{r , echo = FALSE, message = FALSE}
# get sheet_coal with sub_sites from the converted data
sheet_coal <- converted$minerals_ores_conce %>% 
  filter(type_mineral %in% c("Coal mined", "Clean coal"))

# the following code in this chunk is copied from 04b_gap_filling.R
# sheet_coal is loaded from all_tables_converted.rds, i.e. gaps are not filled yet
# the reason is that in this form, sub_sites are still included for coal. 

# mine_fac/year with "Coal mined" or "Clean coal"
coal_mined <- sheet_coal %>%
  filter(type_mineral == "Coal mined") %>%
  distinct(mine_fac, year)

coal_clean <- sheet_coal %>%
  filter(type_mineral == "Clean coal") %>%
  distinct(mine_fac, year)

# mines with reported coal mined for a year, but no Clean coal for that year
mine_list <- setdiff(coal_mined, coal_clean)

# add "Clean coal" where not reported
sheet_coal <- sheet_coal %>% 
  union(
    mine_list %>%
      left_join(sheet_coal %>% filter(type_mineral == "Coal mined")) %>%
      mutate(type_mineral = "Clean coal")
  )

# mines with reported Clean coal, but no coal mined for that year
mine_list <- setdiff(coal_clean, coal_mined)

# add "Coal mined" where not reported
sheet_coal <- sheet_coal %>% 
  union(
    mine_list %>%
      left_join(sheet_coal %>% filter(type_mineral == "Clean coal")) %>%
      mutate(type_mineral = "Coal mined")
  )

# use amount_sold where value = NA in sheet_min
sheet_coal <- sheet_coal %>% 
  mutate(
    value = ifelse(is.na(value) & !is.na(amount_sold), amount_sold, value))

```

<br>

# 1.1 column mine_id is added to all sheets
### Add mine_id to all sheets, rename variables and round columns 
```{r , echo = FALSE, message = FALSE}

ids <- sheet_general_sub_sites %>% 
  select(mine_id, mine_fac, sub_site) %>% 
  st_drop_geometry()

ids_mine_fac_only <- sheet_general %>% 
  select(mine_id, mine_fac) %>% 
  st_drop_geometry()


# for the sheets processing, transport, capacity_reserves, waste, and other info, it can be joined by mine_fac and sub_site
for (i in c(5,6,8,9)){
  detailed[[i]] <- left_join(detailed[[i]], ids, by = c("mine_fac", "sub_site")) %>%
    relocate(mine_id, .before = mine_fac)
}


# 
detailed$capacity_reserves <- left_join(detailed$capacity_reserves, ids_mine_fac_only, by = "mine_fac")


# for the sheet_coal, it can also be joined by mine_fac and sub_site
sheet_coal <- left_join(sheet_coal, ids, by = c("mine_fac", "sub_site"))


# the sheet_min and sheet_com can only be joined with mine_fac, and also only with IDs referring to mine_fac, not sub_site.
sheet_min <- left_join(detailed$minerals_ores_conce, ids_mine_fac_only, by = "mine_fac")
sheet_com <- left_join(detailed$commodities, ids_mine_fac_only, by = "mine_fac")


# similar to sheet_min and sheet_com, as sheet_capacity_reserves is aggregated to mine_fac.  
sheet_cap <- left_join(detailed$capacity_reserves, ids_mine_fac_only, by = "mine_fac")


# delete variables, they do not add value, as it should be at 100%, in tonnes, and in ppm.
# also round values to appropriate digit
sheet_coal <- sheet_coal %>% 
  select(-production_share, -unit, -grade_unit, -no_estimation, -all_metals_overall_grade, -mine_processing) %>% 
  relocate(mine_id, .before = mine_fac) %>% 
  rename(value_tonnes = value, 
         amount_sold_tonnes = amount_sold) %>%
  mutate_at(c("value_tonnes", "amount_sold_tonnes"), round) %>% 
  arrange(mine_id, year, type_mineral) 

sheet_min <- sheet_min %>% 
  filter(., !(type_mineral %in% c("Coal mined", "Clean coal"))) %>%
  select(-production_share, -unit, -grade_unit, -no_estimation) %>% 
  relocate(mine_id, .before = mine_fac) %>% 
  rename(value_tonnes = value,
         amount_sold_tonnes = amount_sold,
         all_metals_overall_grade_ppm = all_metals_overall_grade) %>%
  mutate_at(c("value_tonnes", "amount_sold_tonnes"), round) %>% 
  arrange(mine_id, year, type_mineral)

sheet_com <- sheet_com %>% 
  select(-production_share, -unit, -grade_or_yield_unit, -no_estimation) %>% 
  relocate(mine_id, .before = mine_fac) %>% 
  rename(value_tonnes = value,
         amount_sold_tonnes = amount_sold,
         metal_payable_tonnes = metal_payable,
         grade_ppm = grade, 
         yield_ppm = yield) %>%
  mutate_at(c("value_tonnes", "amount_sold_tonnes", "metal_payable_tonnes"), round, digits = 3) %>% 
  mutate_at(c("grade_ppm", "yield_ppm"), round, digits = 6) %>% 
  arrange(mine_id, year, commodity)

```

<br>

# 2. Four formats for sheet_min and sheet_com are exported

### Format 1: sheet_mineral_coal, sheet_commodity
```{r , echo = FALSE, message = FALSE}

### insert joining ID tbd.


# reorder columns
sheet_min_coal1 <- sheet_min %>%
  bind_rows(sheet_coal) %>%
  select(mine_id, year, type_mineral, min_ore_con, value_tonnes, amount_sold_tonnes, all_metals_overall_grade_ppm, 
         mine_processing, reporting_period, source_id, comment)


sheet_com1 <- sheet_com %>%
  select(mine_id, year, min_ore_con, commodity, value_tonnes, grade_ppm, recovery_rate, yield_ppm, amount_sold_tonnes, 
         metal_payable_tonnes, mine_processing, reporting_period, source_id, comment) 


# datatable for Rmd output
datatable(head(sheet_min_coal1), rownames = FALSE, caption = "sheet_min_coal1")
datatable(head(sheet_com1), rownames = FALSE, caption = "sheet_com1")


# export the sheets
dir.create("./04_output/01_detailed_data/08_final_data/format_1", showWarnings = FALSE, recursive = TRUE)
write_csv(sheet_min_coal1, "./04_output/01_detailed_data/08_final_data/format_1/sheet_minerals_coal.csv", na = "")
write_csv(sheet_com1, "./04_output/01_detailed_data/08_final_data/format_1/sheet_commodities.csv", na = "")

```

<br>

### Format 2: sheet_coal, sheet_mineral, sheet_commodity
```{r , echo = FALSE, message = FALSE}

### insert joining ID tbd.


# reorder columns and modify names 
sheet_coal2 <- sheet_coal %>% 
  select(mine_id, year, type_mineral, min_ore_con, value_tonnes, amount_sold_tonnes, reporting_period, source_id, comment) 


sheet_min2 <- sheet_min %>%
  select(mine_id, year, type_mineral, min_ore_con, value_tonnes, amount_sold_tonnes, all_metals_overall_grade_ppm, 
         mine_processing, reporting_period, source_id, comment)


# datatable for Rmd output
datatable(head(sheet_coal2), rownames = FALSE, caption = "sheet_coal2")
datatable(head(sheet_min2), rownames = FALSE, caption = "sheet_min2")
datatable(head(sheet_com1), rownames = FALSE, caption = "sheet_com1")


# export the sheets
dir.create("./04_output/01_detailed_data/08_final_data/format_2", showWarnings = FALSE, recursive = TRUE)
write_csv(sheet_coal2, "./04_output/01_detailed_data/08_final_data/format_2/sheet_coal.csv", na = "")
write_csv(sheet_min2, "./04_output/01_detailed_data/08_final_data/format_2/sheet_minerals.csv", na = "")
write_csv(sheet_com1, "./04_output/01_detailed_data/08_final_data/format_2/sheet_commodities.csv", na = "") #sheet_com is the same as in format 1, just copy it

```

<br>

### Format 3: sheet_coal, sheet_mineral_commodity
```{r , echo = FALSE, message = FALSE}

# join sheet_min and sheet_com where it is possible and it makes sense (i.e. where type_mineral is "Ore processed" or "Concentrate")
sheet_min_com3 <- full_join(
  sheet_min %>% 
    filter((type_mineral %in% c("Ore processed", "Concentrate"))), # exclude where type_mining is "Ore mined" or "NM mineral"
  sheet_com, 
  by = c("mine_id", "min_ore_con", "year", "mine_processing"), 
  suffix = c("_min", "_com")
)


# cleaning 
### the treatment of sources is likely to be changed
### add that if the sources are equivalent, just keep one entry
sheet_min_com3 <- sheet_min_com3 %>% 
  unite("source_id1", c(source_id_com, source_id_min), sep = "; ", na.rm = TRUE, remove = TRUE) 


# add again the remaining rows (only rows with "Ore mined and NM mineral"). 
sheet_min_com3 <- bind_rows(
  sheet_min_com3, 
  sheet_min %>% 
    filter(!(type_mineral %in% c("Ore processed", "Concentrate")))) # equivalent to: filter(type_mineral %in% c("Ore mined", "NM mineral"))


# cleaning
### the treatment of sources is likely to be changed
### add that if the sources are equivalent, just keep one entry
sheet_min_com3 <- sheet_min_com3 %>% 
  unite("source_ids", c(source_id1, source_id), sep = "; ", na.rm = TRUE, remove = TRUE)


# checking if the reporting periods match for all entries joined
filter(sheet_production2, !is.na(value_min_tonnes) & !is.na(value_com_tonnes)
       & !is.na(reporting_period_min) & is.na(reporting_period_com)) %>% nrow() == 0

filter(sheet_production2, !is.na(value_min_tonnes) & !is.na(value_com_tonnes)
       & is.na(reporting_period_min) & !is.na(reporting_period_com)) %>% nrow() == 0



# reorder columns and rows
sheet_min_com3 <- sheet_min_com3 %>% 
  select(mine_id, year, type_mineral, min_ore_con, value_tonnes_min, amount_sold_tonnes_min, commodity, value_tonnes_com, 
         amount_sold_tonnes_com, grade_ppm, recovery_rate, yield_ppm, #up to here are the most important variables
         all_metals_overall_grade_ppm, metal_payable_tonnes, mine_processing, source_ids, reporting_period_min, reporting_period_com, 
         comment_min, comment_com) %>%
  arrange(mine_id, year, type_mineral) # arranges rows by mine name, year, and type_mineral descending


# datatable for Rmd output
datatable(head(sheet_coal2), rownames = FALSE, caption = "sheet_coal2")
datatable(head(sheet_min_com3), rownames = FALSE, caption = "sheet_min_com3")


# export the sheets
dir.create("./04_output/01_detailed_data/08_final_data/format_3", showWarnings = FALSE, recursive = TRUE)
write_csv(sheet_coal2, "./04_output/01_detailed_data/08_final_data/format_3/sheet_coal.csv", na = "")
write_csv(sheet_min_com3, "./04_output/01_detailed_data/08_final_data/format_3/sheet_minerals_commodities.csv", na = "")

```

<br>

### Format 4:  sheet_mineral_coal_commodity
```{r , echo = FALSE, message = FALSE}

sheet_min_coal_com4 <- bind_rows(sheet_min_com3, sheet_coal2) %>% 
  arrange(mine_id, year, type_mineral)


datatable(head(sheet_min_coal_com4), rownames = FALSE, caption = "sheet_min_coal_com4")


# export the sheet
dir.create("./04_output/01_detailed_data/08_final_data/format_4", showWarnings = FALSE, recursive = TRUE)
write_csv(sheet_min_coal_com4, "./04_output/01_detailed_data/08_final_data/format_4/sheet_minerals_coal_commodities.csv", na = "")

```


<br>

# 3. Other sheets are exported

# export of source_ids
```{r , echo = FALSE, message = FALSE}
source_ids <- source_ids %>% 
  rename(sources = source, 
         source_urls = source_url)

datatable(head(source_ids), rownames = FALSE, caption = "source_ids")

# export the sheet
dir.create("./04_output/01_detailed_data/08_final_data/other_sheets", showWarnings = FALSE, recursive = TRUE)
write_csv(source_ids, "./04_output/01_detailed_data/08_final_data/other_sheets/source_ids.csv", na = "")

```

<br>

# export of sheet_processing
```{r , echo = FALSE, message = FALSE}

sheet_processing <- detailed$processing %>% 
  select(-mine_fac, -sub_site, -process_input_unit, -process_output_unit, -grade_unit, -production_share, -metal_payable) %>% 
  rename(process_input_value_tonnes = process_input_value,
         process_output_value_tonnes = process_output_value, 
         grade_ppm = grade, 
         amount_sold_tonnes = amount_sold) %>% 
  arrange(mine_id, year, process_output)


datatable(head(sheet_processing), rownames = FALSE, caption = "source_ids")


# export the sheet
write_csv(source_ids, "./04_output/01_detailed_data/08_final_data/other_sheets/sheet_processing.csv", na = "")

```

<br>

# export of sheet_transport
```{r , echo = FALSE, message = FALSE}

sheet_transport <- detailed$transport %>% 
  select(-mine_fac, -sub_site, -unit) %>% 
  rename(value_tonnes = value,
         export = "export?") %>%
  arrange(mine_id, year, product)


datatable(head(sheet_transport), rownames = FALSE, caption = "source_ids")


# export the sheet
write_csv(sheet_transport, "./04_output/01_detailed_data/08_final_data/other_sheets/sheet_transport.csv", na = "")

```

<br>

# export of sheet_capacity_reserves (split it up into sheet_capacity and sheet_reserves)
```{r , echo = FALSE, message = FALSE}

# construct sheet_capacity
sheet_capacity <- sheet_cap %>%
  filter(!is.na(processing_capacity_value)) %>%
  select(mine_id, minerals_and_ores, commodity, processing_capacity_year, processing_capacity_value, source_id, comment) %>% 
  rename(value_tonnes = processing_capacity_value,
         year = processing_capacity_year) %>% 
  arrange(mine_id, year, commodity, minerals_and_ores)


# construct sheet_reserves
sheet_reserves <- sheet_cap %>%
  filter(is.na(processing_capacity_value)) %>%
  select(mine_id, minerals_and_ores, commodity, type_mining, reserves_year, 
         reserves_mineral_value, reserves_commodity_value, grade, 
         recovery_id, metallurgical_recovery, source_id, comment) %>% 
  rename(year = reserves_year,
         mineral_value_tonnes = reserves_mineral_value,
         commodity_value_tonnes = reserves_commodity_value,
         grade_ppm = grade) %>% 
  arrange(mine_id, year, commodity, minerals_and_ores)


datatable(head(sheet_capacity), rownames = FALSE, caption = "source_ids")
datatable(head(sheet_reserves), rownames = FALSE, caption = "source_ids")


# export the sheet
write_csv(sheet_capacity, "./04_output/01_detailed_data/08_final_data/other_sheets/sheet_capacity.csv", na = "")
write_csv(sheet_reserves, "./04_output/01_detailed_data/08_final_data/other_sheets/sheet_reserves.csv", na = "")

```

<br>

# export of sheet_waste
```{r , echo = FALSE, message = FALSE}

sheet_waste <- detailed$waste %>% 
  select(-mine_fac, -sub_site, -unit, -production_share) %>% 
  rename(value_tonnes = value) %>% 
  arrange(mine_id, year, mineral, commodity)


datatable(head(sheet_transport), rownames = FALSE, caption = "source_ids")


# export the sheet
write_csv(sheet_transport, "./04_output/01_detailed_data/08_final_data/other_sheets/sheet_ownership.csv", na = "")

```


<br>

# export of sheet_ownership
```{r , echo = FALSE, message = FALSE}

sheet_waste <- detailed$other_info %>% 
  select(-mine_fac, -sub_site) %>% 
  arrange(mine_id, year, owners)


datatable(head(sheet_waste), rownames = FALSE, caption = "source_ids")


# export the sheet
write_csv(sheet_waste, "./04_output/01_detailed_data/08_final_data/other_sheets/sheet_ownership.csv", na = "")

```

